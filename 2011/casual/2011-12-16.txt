plackupでワンライナー + おまけ
meta-author: aska
meta-tags: perl

はい、One Page Appsの@su_askaです。

今日はちゃんとPerlの話をしようと思います。

* plackupでワンライナー

** envをげろげろーってするやつ

>|perl|
plackup -e "sub { use Data::Dumper;warn Dumper(@_);[200, [], ['ok']] }"
||<

※補足: Proxyを使用している際のIPアドレスや検証用携帯電話のUAを確認

** give me 適当なヘッダー

>|perl|
plackup -e "sub { [404, ['X-XRDS-Location', 'http://www.example.jp/xrds'], ['404']] }"
||<

※補足: Yadisの検証

** CPANにUPする前に欠かせない紳士のPODチェック

>|perl|
plackup -MDocLife::Pod -e 'DocLife::Pod->new( root => "./lib" )->to_app'
||<

※補足: CPANっぽくPOD表示するHTTPDが上がります

* まとめ

ワンライナーのいいところはゴミ残らない所ですが、

前書いたワンライナーまた使いたいって時に出てこないのがわるいところですね!

<strong>じゃあgistにあげとけよタコ!!!!</strong>

で、gistに上げてたら今度は検索できなくて詰んだりします。

そういう時は下のAPIをブラウザでアクセスしてCtrl-Fしましょう。

https://api.github.com/users/s-aska/gists (s-askaの所はあなたのIDにしてね!)

descriptionとか埋めてないとこれでも探せないので埋めておいた方が良いです。

はいっ、次の話題に移ります、ネタなんか薄いので色々持ってきました。

* ガラケーサイト with Plack::Session

Amon2::Setup::Flavor::MobileJP 便利ですよ! (詳しくはamon2トラック参照)

Amon2::Setup::Flavor::MobileJP !! (大事なことなので2回言いました)

Plack::MiddlewareでSession使う必要があり、

HTTP::SessionからURIに埋めるヤツを複写して使っていたのですが、

今はcpanに上げています。

Plack::Session::State::URI使うとcookieダメな子も安心!

※CookieいけるときはCookieで的な事まではしてないです、ごめんよ

>|perl|
enable 'Plack::Middleware::Session',
    %{ $config->{Session} },
    state => Plack::Session::State::URI->new(
        session_id_name => 'sss',
    );
||<

* MySQL Casual with Teng

jsonの値MySQLに突っ込みたい時に xxx_json 的なカラムは自動en/decodeする的なコード

よくある_onをDateTimeにする奴とかと一緒な感じですね。 (詳しくはtengトラック参照)

やり方は色々あります、以下はあくまでサンプルという事でお願いします。

>|perl|
sub db {
    my $c = shift;
    unless ( defined $c->{db} ) {
        my $conf = $c->config->{DBI}
          or die "missing configuration for 'DB'";
        my $dbh = DBI->connect(@$conf);
        my $schema = Teng::Schema::Loader->load(
            namespace => 'MyApp::DB',
            dbh => $dbh
        );
        for my $table (values %{ $schema->tables }) {
            for my $column (grep /_json$/, @{ $table->columns }) {
                $table->add_inflator($column, sub {
                    $_[0] ? decode_json(shift) : {}
                });
                $table->add_deflator($column, sub {
                    encode_json(shift)
                });
            }
        }
        $c->{db} = MyApp::DB->new(
            dbh    => $dbh,
            schema => $schema
        );
    }
    return $c->{db};
}
||<

- スキーマから定義
- _json で終わるカラム名は自動 en/decode
- カラム拡張とかもしたいので MyApp::DB は書いてある

* Perlのススメ

このエントリーを見てくれた人の中には

「実は私まだPerl Mongerじゃ...」という方もいるかも知れません（居ないよ!!）

なので色々紹介してみましょう!!

** 書

みんなもどんどん書いてみよう!

- 初めてのPerl
- 続・初めてのPerl
- モダンPerl入門
- Perl CPANモジュールガイド
- 体系的に学ぶ 安全なWebアプリケーションの作り方

** 環境

今更感満載ですがこれが全部揃わないことにはperlの開発は始まりません!!

- perlbrew ... システムPerlで開発しちゃらめーーー
- cpanm ... モジュールのインストールはもちろん
- carton ... バージョン管理もバッチリ
- Plack ... mod_perlはオワコン
- git ... 商用のVCS使ったことねーから!!
- TextMate ... EmacsやVimが人気ですが個人的にはTextMateが好みです
- MBP ... やっぱり開発はUnixが望ま...、おっと<a href="http://mattn.kaoriya.net">mattn</a>さんの影が
- 水 ... 長時間開発する際は適度な水分補給を忘れずに

** 超頻用Module

アプリ書く時にほぼ毎回全部使う奴ですね!!!

- Amon2 ... 紳士はCatalystと聞くと重たい気持ちになる
- JSON ... 紳士はXMLなんて使わないんです（ｷﾘｯ
- Xslate ... 紳士はTTとかマジ勘弁
- Furl ... LWP使っていいのは小学生まで
- Teng ... Liteな時は Amon2::DBI, DBIx::Simple あたりがオススメ

** 集い

#perl-casual@freenode.netや各地PM、最近はTwitterもあるので気軽にやり取りできるようになりました。

まずはビールからという人はPMに顔を出すのが一番手っ取り早いと懐います、あとMySQL Casualとかいいと思います、私は泥酔して@myfinderさんにご迷惑を（ｒｙ

あとはPerl話沢山聴きたい時はYAPCですが年に一回でチケットが売り切れ続出なので早目にチェックするといいと思います、トークするとチケット無料です、やったね！（ｒｙ

** 今年の戦果

1記事書かせて頂いた記念に自分の成果物を晒したいと思います!

来年もいっぱいなにか作ってると思います!!

- DocLife ... cpan/githubのお供に
- dropbox-api-command ... Linux環境でデーモンじゃなくてスクリプトでDropbox扱いたい時に
- bookma!{ぶ) ... http://bookma.org/
- MarkdownBinder ... http://doc.7kai.org/ (wikiっぽいMarkdownビューア )
- MarkdownDiary ... http://blog.7kai.org/ (blogっぽいMarkdownビューア )
- 7kai Tasks ...https://tasks.7kai.org/ (ソーシャルタスク管理サービス)

明日は Werlのダメ人間 さんです。お楽しみに！
